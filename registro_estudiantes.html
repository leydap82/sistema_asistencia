<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Estudiantes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(120deg, #3498db, #2ecc71, #ffffff);
            color: #fff;
            text-align: center;
            padding: 20px;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #fff;
            color: #333;
            border-radius: 10px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2ecc71;
        }
        .logo {
            width: 150px;
            margin-bottom: 20px;
            margin-left: -4cm; /* Ajuste de la posición del logo */
        }
    </style>
</head>
<body>
    <!-- Incluir el logo al inicio -->
    <img src="img/logo.png" alt="Logo de la Institución" class="logo">

    <h1>Registro de Estudiantes</h1>

    <!-- Formulario para registrar estudiantes manualmente -->
    <form id="studentForm">
        <input type="text" id="studentID" placeholder="ID del Estudiante" required><br><br>
        <input type="text" id="nombre" placeholder="Nombre del Estudiante" required><br><br>
        <input type="text" id="ciclo" placeholder="Ciclo del Estudiante"><br><br>
        <button type="submit">Registrar Estudiante</button>
    </form>

    <br><br>

    <!-- Importar estudiantes desde archivo Excel -->
    <h2>Importar Estudiantes desde Excel</h2>
    <input type="file" id="inputExcel" accept=".xlsx, .xls" />
    <button onclick="importarDesdeExcel()">Importar Estudiantes</button>

    <!-- Tabla para mostrar la lista de estudiantes -->
    <h2>Lista de Estudiantes</h2>
    <table id="tablaEstudiantes">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Ciclo</th>
                <th>Fecha Registro</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Filtrar estudiantes por fecha y generar reporte -->
    <h2>Filtrar Estudiantes por Fecha</h2>
    <input type="date" id="filterDate" />
    <button onclick="generarReporte()">Generar Reporte</button>

    <!-- Librería SheetJS para manejar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <script>
        // Función para registrar manualmente un estudiante y agregarlo a la tabla y LocalStorage
        document.getElementById('studentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const studentID = document.getElementById('studentID').value;
            const nombre = document.getElementById('nombre').value;
            const ciclo = document.getElementById('ciclo').value;
            const fecha = new Date().toLocaleDateString();  // Fecha actual

            const estudiante = { studentID, nombre, ciclo, fecha };
            agregarEstudianteATabla(estudiante);

            let estudiantes = JSON.parse(localStorage.getItem('estudiantes')) || [];
            estudiantes.push(estudiante);

            localStorage.setItem('estudiantes', JSON.stringify(estudiantes));

            document.getElementById('studentForm').reset();
        });

        // Función para agregar un estudiante a la tabla HTML
        function agregarEstudianteATabla(estudiante) {
            const tableBody = document.querySelector('#tablaEstudiantes tbody');
            const row = document.createElement('tr');

            const cellID = document.createElement('td');
            const cellNombre = document.createElement('td');
            const cellCiclo = document.createElement('td');
            const cellFecha = document.createElement('td');

            cellID.textContent = estudiante.studentID;
            cellNombre.textContent = estudiante.nombre;
            cellCiclo.textContent = estudiante.ciclo || "Sin ciclo";
            cellFecha.textContent = estudiante.fecha;

            row.appendChild(cellID);
            row.appendChild(cellNombre);
            row.appendChild(cellCiclo);
            row.appendChild(cellFecha);
            tableBody.appendChild(row);
        }

        // Cargar estudiantes desde LocalStorage cuando la página se cargue
        window.onload = function() {
            const estudiantes = JSON.parse(localStorage.getItem('estudiantes')) || [];
            estudiantes.forEach(estudiante => agregarEstudianteATabla(estudiante));
        }

        // Función para leer Excel e importar estudiantes
        function importarDesdeExcel() {
            const inputExcel = document.getElementById('inputExcel');
            const file = inputExcel.files[0];

            if (!file) {
                alert('Por favor, selecciona un archivo Excel.');
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                const estudiantes = [];
                jsonData.forEach((row, index) => {
                    if (index !== 0 && row.length > 0) {  // Omitir la fila de encabezado
                        const estudiante = {
                            studentID: row[0],
                            nombre: row[1],
                            ciclo: row[2] || "Sin ciclo",
                            fecha: new Date().toLocaleDateString()  // Asignar fecha actual al importar
                        };
                        agregarEstudianteATabla(estudiante);
                        estudiantes.push(estudiante);
                    }
                });

                // Guardar en LocalStorage
                const estudiantesPrevios = JSON.parse(localStorage.getItem('estudiantes')) || [];
                const nuevosEstudiantes = estudiantesPrevios.concat(estudiantes);
                localStorage.setItem('estudiantes', JSON.stringify(nuevosEstudiantes));
            };

            reader.readAsArrayBuffer(file);
        }

        // Filtrar estudiantes por fecha y generar reporte
        function generarReporte() {
            const filterDate = document.getElementById('filterDate').value;
            if (!filterDate) {
                alert('Por favor, selecciona una fecha para generar el reporte.');
                return;
            }

            const estudiantes = JSON.parse(localStorage.getItem('estudiantes')) || [];
            if (estudiantes.length === 0) {
                alert('No hay estudiantes registrados.');
                return;
            }

            const estudiantesFiltrados = estudiantes.filter(estudiante => {
                const fechaEstudiante = new Date(estudiante.fecha).toISOString().split('T')[0];
                return fechaEstudiante === filterDate;
            });

            if (estudiantesFiltrados.length === 0) {
                alert('No se encontraron estudiantes para la fecha seleccionada.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,ID Estudiante,Nombre,Ciclo,Fecha de Registro\n";
            estudiantesFiltrados.forEach(estudiante => {
                csvContent += `${estudiante.studentID},${estudiante.nombre},${estudiante.ciclo},${estudiante.fecha}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `reporte_estudiantes_${filterDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>